Marionette.Module=function(e,t,n){this.moduleName=e,this.options=_.extend({},this.options,n),this.initialize=n.initialize||this.initialize,this.submodules={},this._setupInitializersAndFinalizers(),this.app=t,this.startWithParent=!0,this.triggerMethod=Marionette.triggerMethod,_.isFunction(this.initialize)&&this.initialize(this.options,e,t)},Marionette.Module.extend=Marionette.extend,_.extend(Marionette.Module.prototype,Backbone.Events,{initialize:function(){},addInitializer:function(e){this._initializerCallbacks.add(e)},addFinalizer:function(e){this._finalizerCallbacks.add(e)},start:function(e){if(this._isInitialized)return;_.each(this.submodules,function(t){t.startWithParent&&t.start(e)}),this.triggerMethod("before:start",e),this._initializerCallbacks.run(e,this),this._isInitialized=!0,this.triggerMethod("start",e)},stop:function(){if(!this._isInitialized)return;this._isInitialized=!1,Marionette.triggerMethod.call(this,"before:stop"),_.each(this.submodules,function(e){e.stop()}),this._finalizerCallbacks.run(undefined,this),this._initializerCallbacks.reset(),this._finalizerCallbacks.reset(),Marionette.triggerMethod.call(this,"stop")},addDefinition:function(e,t){this._runModuleDefinition(e,t)},_runModuleDefinition:function(e,t){if(!e)return;var n=_.flatten([this,this.app,Backbone,Marionette,Marionette.$,_,t]);e.apply(this,n)},_setupInitializersAndFinalizers:function(){this._initializerCallbacks=new Marionette.Callbacks,this._finalizerCallbacks=new Marionette.Callbacks}}),_.extend(Marionette.Module,{create:function(e,t,n){var r=e,i=slice.call(arguments);i.splice(0,3),t=t.split(".");var s=t.length,o=[];return o[s-1]=n,_.each(t,function(t,s){var u=r;r=this._getModule(u,t,e,n),this._addModuleDefinition(u,r,o[s],i)},this),r},_getModule:function(e,t,n,r,i){var s=_.extend({},r),o=this.getClass(r),u=e[t];return u||(u=new o(t,n,s),e[t]=u,e.submodules[t]=u),u},getClass:function(e){var t=Marionette.Module;return e?e.prototype instanceof t?e:e.moduleClass||t:t},_addModuleDefinition:function(e,t,n,r){var i=this._getDefine(n),s=this._getStartWithParent(n,t);i&&t.addDefinition(i,r),this._addStartWithParent(e,t,s)},_getStartWithParent:function(e,t){var n;return _.isFunction(e)&&e.prototype instanceof Marionette.Module?(n=t.constructor.prototype.startWithParent,_.isUndefined(n)?!0:n):_.isObject(e)?(n=e.startWithParent,_.isUndefined(n)?!0:n):!0},_getDefine:function(e){return!_.isFunction(e)||e.prototype instanceof Marionette.Module?_.isObject(e)?e.define:null:e},_addStartWithParent:function(e,t,n){t.startWithParent=t.startWithParent&&n;if(!t.startWithParent||!!t.startWithParentIsConfigured)return;t.startWithParentIsConfigured=!0,e.addInitializer(function(e){t.startWithParent&&t.start(e)})}});